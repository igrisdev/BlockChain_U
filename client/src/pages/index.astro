---
import Check from '../assets/icons/Check.astro';
import NoCheck from '../assets/icons/NoCheck.astro';
import Layout from '../layouts/Layout.astro';

import type { CadenaCelulares, Listar } from '../env.d.ts';

const columnasNames = ["Index", "Nombres", "Documento", "IMEI", "Modelo", "Marca", "Precio", "Reportado", "Fecha"
]

const celulares : CadenaCelulares = await fetch('http://localhost:3000').then((res) => res.json());

const celulares2 : Listar[] = celulares.listar;

const listarCelulares = celulares2.slice(1).map((celular) => {
  return {
    index: celular.index,
    nombres: celular.data.propietario?.nombres,
    documento: celular.data.propietario?.id_propietario,
    imei: celular.data.imei,
    modelo: celular.data.modelo,
    marca: celular.data.marca,
    precio: celular.data.precio,
    estaReportado: celular.data.estaReportado,
    fecha: celular.date.toString().slice(0, 10)
  }
})

console.log(listarCelulares);
---

<Layout title="Welcome to Astro.">
	<header class="text-center pt-4">
    <div>
      <h1 class='text-white text-6xl font-bold'>Celulares</h1>
      <span class='text-lg text-amber-400'>Blockchain</span>
    </div>
  </header>

  <main class="pt-7">
    <section id='botones' class='flex items-center justify-center flex-wrap gap-2'>
      <button data-section="todos-celulares" class='px-5 py-3 bg-slate-300 text-black rounded-md font-medium'>Todos los Celular</button>
      <button data-section="verificar-celular" class='px-5 py-3 bg-red-300 text-black rounded-md font-medium'>Verificar Celular</button>
      <button data-section="comprar-celular" class='px-5 py-3 bg-green-300 text-black rounded-md font-medium'>Comprar Celular</button>
      <button data-section="revender-celular" class='px-5 py-3 bg-purple-300 text-black rounded-md font-medium'>Revender Celular</button>
      <button data-section="reportar-celular" class='px-5 py-3 bg-blue-300 text-black rounded-md font-medium'>Reportar Celular</button>
    </section>

    <section id='todas-secciones' class='py-5'>
      <div data-section='todos-celulares' class="relative overflow-x-auto overflow-y-auto max-h-[600px] shadow-md sm:rounded-lg">
        <table class="w-full text-sm text-left text-gray-500">
            <caption class="p-5 text-lg font-semibold text-left text-gray-900 bg-slate-300">
                Lista de todos los celulares registrados
                <p class="mt-1 text-sm font-normal text-gray-500">Browse a list of Flowbite products designed to help you work and play, stay organized, get answers, keep in touch, grow your business, and more.</p>
            </caption>
            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                <tr>
                  {
                    columnasNames.map((columna) => {
                      return (
                        <th scope="col" class="px-6 py-3">
                          {columna}
                        </th>
                      )
                    })
                  }
                </tr>
            </thead>
            <tbody>
              {listarCelulares.map(({index, nombres, documento, imei, modelo, marca, precio, estaReportado, fecha} ): Listar => (
                <tr class="bg-slate-300 border-b">
                    <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">
                        {index}
                    </th>
                    <td class="px-6 py-4">
                        {nombres}
                    </td>
                    <td class="px-6 py-4">
                        {documento}
                    </td>
                    <td class="px-6 py-4">
                        {imei}
                    </td>
                    <td class="px-6 py-4">
                        {modelo}
                    </td>
                    <td class="px-6 py-4">
                        {marca}
                    </td>
                    <td class="px-6 py-4">
                        {precio}
                    </td>
                    <td class="px-6 py-4 flex items-center justify-center">
                        {estaReportado ? <Check class='text-green-500' /> : <NoCheck class='text-red-500' />}
                    </td>
                    <td class="px-6 py-4">
                        {fecha}
                    </td>
                </tr>
              ))}
            </tbody>
        </table>
      </div>

      <div data-section='verificar-celular' class='hidden'>
        <div>
          <form id='form-verificar-celular' class="relative">
            <div class="relative">
              <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
                <svg class="w-4 h-4 text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
                </svg>
              </div>

              <input type="search" id="default-search" name='imei' class="text-white block w-full p-4 ps-10 text-sm border rounded-lg bg-gray-700 border-gray-600 placeholder-gray-400 text-white" placeholder="Ingresar IMEI: 100.." required />

              <button type="submit" class="text-white absolute end-2.5 bottom-2.5 font-medium rounded-lg text-sm px-4 py-2 bg-blue-600 hover:bg-blue-700">Comprobar</button>
            </div>
          </form>
        </div>

        <div>

        </div>
      </div>

      <div data-section="comprar-celular" class='mt-5 hidden'>
        <form id='form-comprar-celular' class="max-w-2xl mx-auto">
          <div class="grid md:grid-cols-2 md:gap-6">
            <div class="relative z-0 w-full mb-5 group">
                <input type="text" name="nombres" id="floating_first_name" class="text-white block py-2.5 px-0 w-full text-sm text-gray-900 bg-transparent border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer" placeholder=" " required />
                <label for="floating_first_name" class="peer-focus:font-medium absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:start-0 rtl:peer-focus:translate-x-1/4 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6">Nombres y Apellidos</label>
            </div>
            <div class="relative z-0 w-full mb-5 group">
                <input type="number" name="id_propietario" id="floating_last_name" class="text-white block py-2.5 px-0 w-full text-sm text-gray-900 bg-transparent border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer" placeholder=" " required />
                <label for="floating_last_name" class="peer-focus:font-medium absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:start-0 rtl:peer-focus:translate-x-1/4 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6">Documento de Identidad</label>
            </div>
          </div>
          <div class="relative z-0 w-full mb-5 group">
              <input type="text" name="modelo" id="floating_email" class="text-white block py-2.5 px-0 w-full text-sm text-gray-900 bg-transparent border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer" placeholder=" " required />
              <label for="floating_email" class="peer-focus:font-medium absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:start-0 rtl:peer-focus:translate-x-1/4 rtl:peer-focus:left-auto peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6">Modelo del celular</label>
          </div>
          <div class="grid md:grid-cols-2 md:gap-6">
            <div class="relative z-0 w-full mb-5 group">
                <input type="number" name="imei" id="floating_first_name" class="text-white block py-2.5 px-0 w-full text-sm text-gray-900 bg-transparent border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer" placeholder=" " required />
                <label for="floating_first_name" class="peer-focus:font-medium absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:start-0 rtl:peer-focus:translate-x-1/4 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6">IMEI único del celular</label>
            </div>
            <div class="relative z-0 w-full mb-5 group">
                <input type="text" name="marca" id="floating_last_name" class="text-white block py-2.5 px-0 w-full text-sm text-gray-900 bg-transparent border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer" placeholder=" " required />
                <label for="floating_last_name" class="peer-focus:font-medium absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:start-0 rtl:peer-focus:translate-x-1/4 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6">Marca del celular</label>
            </div>
          </div>
          <div class="relative z-0 w-full mb-5 group">
            <input type="number" name="precio" id="floating_email" class="text-white block py-2.5 px-0 w-full text-sm text-gray-900 bg-transparent border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer" placeholder=" " required />
            <label for="floating_email" class="peer-focus:font-medium absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:start-0 rtl:peer-focus:translate-x-1/4 rtl:peer-focus:left-auto peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6">Precio del celular</label>
          </div>
          <button type="submit" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm w-full sm:w-auto px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Realizar Compra</button>
        </form>
      </div>

      <div data-section="revender-celular" class='mt-5 hidden'>
        <form id='form-revender-celular' class="max-w-2xl mx-auto">
          <div class="grid md:grid-cols-2 md:gap-6">
            <div class="relative z-0 w-full mb-5 group">
                <input type="text" name="nombreNuevoPropietario" id="floating_first_name" class="text-white block py-2.5 px-0 w-full text-sm text-gray-900 bg-transparent border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer" placeholder=" " required />
                <label for="floating_first_name" class="peer-focus:font-medium absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:start-0 rtl:peer-focus:translate-x-1/4 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6">Nombres y Apellidos</label>
            </div>
            <div class="relative z-0 w-full mb-5 group">
                <input type="number" name="idPropietario" id="floating_last_name" class="text-white block py-2.5 px-0 w-full text-sm text-gray-900 bg-transparent border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer" placeholder=" " required />
                <label for="floating_last_name" class="peer-focus:font-medium absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:start-0 rtl:peer-focus:translate-x-1/4 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6">Documento de Identidad</label>
            </div>
          </div>
          <div class="grid md:grid-cols-2 md:gap-6">
            <div class="relative z-0 w-full mb-5 group">
                <input type="number" name="IMEI" id="floating_first_name" class="text-white block py-2.5 px-0 w-full text-sm text-gray-900 bg-transparent border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer" placeholder=" " required />
                <label for="floating_first_name" class="peer-focus:font-medium absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:start-0 rtl:peer-focus:translate-x-1/4 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6">IMEI único del celular</label>
            </div>
            <div class="relative z-0 w-full mb-5 group">
                <input type="number" name="precio" id="floating_last_name" class="text-white block py-2.5 px-0 w-full text-sm text-gray-900 bg-transparent border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer" placeholder=" " required />
                <label for="floating_last_name" class="peer-focus:font-medium absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:start-0 rtl:peer-focus:translate-x-1/4 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6">Precio del celular</label>
            </div>
          </div>
          <button type="submit" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm w-full sm:w-auto px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Revender Celular</button>
        </form>
      </div>

      <div data-section="reportar-celular" class='mt-5 hidden'>
        <form id='form-reportar-celular' class="max-w-2xl mx-auto">
          <div class="relative z-0 w-full mb-5 group">
              <input type="text" name="IMEI" id="floating_email" class="text-white block py-2.5 px-0 w-full text-sm text-gray-900 bg-transparent border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer" placeholder=" " required />
              <label for="floating_email" class="peer-focus:font-medium absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:start-0 rtl:peer-focus:translate-x-1/4 rtl:peer-focus:left-auto peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6">IMEI único del celular</label>
          </div>
          <div class="relative z-0 w-full mb-5 group">
            <input type="number" name="idPropietario" id="floating_email" class="text-white block py-2.5 px-0 w-full text-sm text-gray-900 bg-transparent border-0 border-b-2 border-gray-300 appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer" placeholder=" " required />
            <label for="floating_email" class="peer-focus:font-medium absolute text-sm text-gray-500 dark:text-gray-400 duration-300 transform -translate-y-6 scale-75 top-3 -z-10 origin-[0] peer-focus:start-0 rtl:peer-focus:translate-x-1/4 rtl:peer-focus:left-auto peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-focus:scale-75 peer-focus:-translate-y-6">Documento de Identidad</label>
          </div>
          <button type="submit" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm w-full sm:w-auto px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Reportar Celular</button>
        </form>
      </div>
    </section>

  </main>
</Layout>


<script>
  const $ = (selector: string) => document.querySelector(selector);
  const $$ = (selector: string) => document.querySelectorAll(selector);

  const todasSecciones = $$('#todas-secciones > div') as NodeListOf<HTMLDivElement>;
  const sectionButtons = $$('#botones button') as NodeListOf<HTMLButtonElement>;

  sectionButtons.forEach((button: HTMLButtonElement) => {
    button.addEventListener('click', (e) => {
      const buttonSection = (e.currentTarget as HTMLButtonElement).dataset.section;

      todasSecciones.forEach((section: HTMLDivElement) => {
        const sectionId = section.dataset.section;
        if (sectionId === buttonSection) {
          section.classList.remove('hidden');
        } else {
          section.classList.add('hidden');
        }
      });
    });
  });

  // verificar-celular
  const formVerificarCelular = $('#form-verificar-celular') as HTMLFormElement

  formVerificarCelular.onsubmit = async (e) => {
    e.preventDefault();

    const form = new FormData(formVerificarCelular)

    let response = await fetch('http://localhost:3000/comprobar_robo/' + form.get('imei'));

    let result = await response.json();

    if (result.ok) {
      alert(result.mensaje);
    } else {
      alert(result);
    }

    formVerificarCelular.reset();
  };

  // comprar-celular
  const formComprarCelular = $('#form-comprar-celular') as HTMLFormElement

  formComprarCelular.onsubmit = async (e) => {
    e.preventDefault();

    const form = new FormData(formComprarCelular)

    const celular = {
      imei: form.get('imei'),
      modelo: form.get('modelo'),
      marca: form.get('marca'),
      precio: form.get('precio'),
      propietario: {
        id_propietario: form.get('id_propietario'),
        nombres: form.get('nombres')
      }
    }

    let response = await fetch('http://localhost:3000/comprar_celular', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(celular)
    });

    let result = await response.json();

    if (result.ok) {
      alert(result.mensaje);
    } else {
      alert(result);
    }

    formComprarCelular.reset();
  };

  // revender-celular
  const formRevenderCelular = $('#form-revender-celular') as HTMLFormElement

  formRevenderCelular.onsubmit = async (e) => {
    e.preventDefault();

    const form = new FormData(formRevenderCelular)

    const celular = {
      IMEI: form.get('IMEI'),
      precio: form.get('precio'),
      idPropietario: form.get('idPropietario'),
      nombreNuevoPropietario: form.get('nombreNuevoPropietario')
    }

    let response = await fetch('http://localhost:3000/revender_celular', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(celular)
    });

    let result = await response.json();

    if (result.ok) {
      alert(result.mensaje);
    } else {
      alert(result);
    }

    formRevenderCelular.reset();
  };

  // comprar-celular
  const formReportarCelular = $('#form-reportar-celular') as HTMLFormElement

  formReportarCelular.onsubmit = async (e) => {
    e.preventDefault();

    const form = new FormData(formReportarCelular)

    let response = await fetch(`http://localhost:3000/reportar_robo/${form.get('IMEI')}/${form.get('idPropietario')}`, {
      method: 'PUT'
    });

    let result = await response.json();

    if (result.ok) {
      alert(result.mensaje);
    } else {
      alert(result);
    }

    formReportarCelular.reset();
  };
</script>
